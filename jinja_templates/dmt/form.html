<div class="bg-white rounded-xl shadow-xl p-8">

    <div class="flex justify-between items-center mb-6">

        <h2 class="text-3xl font-bold text-gray-800">

            {% if record %}Edit DMT Report #{{ record.report_number }}{% else %}Create New DMT Report{% endif %}

        </h2>



        {% if record %}

        <div class="flex gap-2 items-center">

            <span class="px-4 py-2 rounded-lg font-semibold text-sm

                {% if record.workflow_status == 'draft' %}bg-gray-200 text-gray-700

                {% elif record.workflow_status == 'supervisor_review' %}bg-blue-200 text-blue-700

                {% elif record.workflow_status == 'manager_review' %}bg-yellow-200 text-yellow-700

                {% elif record.workflow_status == 'engineer_review' %}bg-purple-200 text-purple-700

                {% elif record.workflow_status == 'completed' %}bg-green-200 text-green-700

                {% endif %}">

                {{ record.workflow_status.replace('_', ' ').title() }}

            </span>



            <span class="px-4 py-2 rounded-lg font-semibold text-sm

                {% if record.status == 'open' %}bg-green-200 text-green-700

                {% else %}bg-red-200 text-red-700{% endif %}">

                {{ record.status.title() }}

            </span>



            {% if record.is_session %}

            <span class="px-4 py-2 rounded-lg font-semibold text-sm bg-orange-200 text-orange-700">

                Session (Draft)

            </span>

            {% endif %}

        </div>

        {% endif %}

    </div>



    <!-- Added error message display -->

    <div id="form-error-message" class="hidden mb-4 p-4 bg-red-100 border-2 border-red-400 text-red-700 rounded-lg">

        <strong>Error:</strong> <span id="error-text"></span>

    </div>



    <form id="dmt-form">

        <input type="hidden" name="save_as_session" id="save_as_session" value="false">



        {% macro render_selector(name, label, options, selected='', disabled=False, required=True) %}

        <div>

            <label class="block text-sm font-semibold text-gray-700 mb-1">

                {{ label }} {% if required and not disabled %}<span class="text-red-600">*</span>{% endif %}

            </label>

            <select name="{{ name }}" {% if required and not disabled %}required{% endif %}
                class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                {% if disabled %}disabled{% endif %}>

                <option value="">-- Select --</option>

                {% for opt in options %}

                <option value="{{ opt.id }}" {% if opt.id==selected or opt.name==selected %}selected{% endif %}>{{
                    opt.name }}</option>

                {% endfor %}

            </select>

        </div>

        {% endmacro %}



        {% macro render_input(name, label, value='', input_type='text', disabled=False, required=True) %}

        <div>

            <label class="block text-sm font-semibold text-gray-700 mb-1">

                {{ label }} {% if required and not disabled %}<span class="text-red-600">*</span>{% endif %}

            </label>

            <input type="{{ input_type }}" name="{{ name }}" value="{{ value }}" {% if required and not disabled
                %}required{% endif %}
                class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                {% if disabled %}disabled{% endif %}>

        </div>

        {% endmacro %}



        {% macro render_employee_search(name, label, selected_id='', selected_name='', disabled=False, required=True) %}

        <div class="relative">

            <label class="block text-sm font-semibold text-gray-700 mb-1">

                {{ label }} {% if required and not disabled %}<span class="text-red-600">*</span>{% endif %}

            </label>

            <input type="text" id="{{ name }}_search" placeholder="Search by name, ID, or employee number..."
                value="{{ selected_name }}"
                class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                autocomplete="off" {% if disabled %}disabled{% endif %} hx-get="/dmt/search/employees"
                hx-trigger="keyup changed delay:300ms" hx-target="#{{ name }}_results"
                hx-include="[id='{{ name }}_search']"
                hx-vals='js:{"q": document.getElementById("{{ name }}_search").value}'>

            <input type="hidden" name="{{ name }}" id="{{ name }}_hidden" value="{{ selected_id }}" {% if required and
                not disabled %}required{% endif %}>

            <div id="{{ name }}_results"
                class="absolute z-50 w-full bg-white border-2 border-gray-300 rounded-lg mt-1 max-h-60 overflow-y-auto shadow-lg hidden">

            </div>

        </div>

        {% endmacro %}



        {% macro render_textarea(name, label, value='', disabled=False, required=True) %}

        <div>

            <label class="block text-sm font-semibold text-gray-700 mb-1">

                {{ label }} {% if required and not disabled %}<span class="text-red-600">*</span>{% endif %}

            </label>

            <textarea name="{{ name }}" rows="3" {% if required and not disabled %}required{% endif %}
                class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                {% if disabled %}disabled{% endif %}>{{ value }}</textarea>

        </div>

        {% endmacro %}



        {% macro render_checkbox(name, label, checked=False, disabled=False) %}

        <div class="flex items-center">

            <input type="checkbox" name="{{ name }}" id="{{ name }}" {% if checked %}checked{% endif %} {% if disabled
                %}disabled{% endif %}
                class="w-5 h-5 text-blue-600 border-gray-300 rounded focus:ring-2 focus:ring-blue-500">

            <label for="{{ name }}" class="ml-2 text-sm font-semibold text-gray-700">{{ label }}</label>

        </div>

        {% endmacro %}



        <div
            class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-6 border-2 border-blue-200 {% if not permissions.general_info %}opacity-60{% endif %}">

            <h3 class="text-xl font-bold text-gray-800 mb-4">

                üìã General Information <span class="text-red-600">*</span>

                {% if not permissions.general_info and record.status != 'closed' %}

                <span class="text-sm font-normal text-gray-600">(Supervisor Only)</span>

                {% elif record.status == 'closed' %}

                <span class="text-sm font-normal text-red-600">(Closed - Read Only)</span>

                {% endif %}

            </h3>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">

                {{ render_selector('work_center', 'Work Center', selectors.workcenters, record.work_center if record
                else '', not permissions.general_info, True) }}

                {{ render_selector('part_num', 'Part Number', selectors.partnumbers, record.part_num if record else '',
                not permissions.general_info, True) }}

                {{ render_input('operation', 'Operation', record.operation if record else '', 'text', not
                permissions.general_info, True) }}

                {{ render_employee_search('employee_name', 'Employee', record.employee_name if record else '',
                record.employee_name if record else '', not permissions.general_info, True) }}

                {{ render_input('qty', 'Quantity', record.qty if record else '', 'text', not permissions.general_info,
                True) }}

                {{ render_selector('customer', 'Customer', selectors.customers, record.customer if record else '', not
                permissions.general_info, True) }}

                {{ render_input('shop_order', 'Shop Order', record.shop_order if record else '', 'text', not
                permissions.general_info, True) }}

                {{ render_input('serial_number', 'Serial Number', record.serial_number if record else '', 'text', not
                permissions.general_info, True) }}

                {{ render_selector('inspection_item', 'Inspection Item', selectors.inspection_items,
                record.inspection_item if record else '', not permissions.general_info, True) }}

                {{ render_input('date', 'Date', record.date if record else '', 'date', not permissions.general_info,
                True) }}

                {{ render_selector('prepared_by', 'Prepared By', selectors.prepared_by, record.prepared_by if record
                else '', not permissions.general_info, True) }}

            </div>

        </div>



        <div
            class="bg-gradient-to-br from-red-50 to-red-100 rounded-xl p-6 border-2 border-red-200 mt-6 {% if not permissions.defect_description %}opacity-60{% endif %}">

            <h3 class="text-xl font-bold text-gray-800 mb-4">

                ‚ö†Ô∏è Defect Description <span class="text-red-600">*</span>

                {% if not permissions.defect_description and record.status != 'closed' %}

                <span class="text-sm font-normal text-gray-600">(Supervisor Only)</span>

                {% elif record.status == 'closed' %}

                <span class="text-sm font-normal text-red-600">(Closed - Read Only)</span>

                {% endif %}

            </h3>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

                {{ render_textarea('description', 'Description', record.description if record else '', not
                permissions.defect_description, True) }}

                <div class="space-y-4">

                    {{ render_selector('car_type', 'CAR Type', selectors.car_types, record.car_type if record else '',
                    not permissions.defect_description, True) }}

                    {{ render_input('car_cycle', 'CAR Cycle', record.car_cycle if record else '', 'text', not
                    permissions.defect_description, True) }}

                    {{ render_input('car_second_cycle_date', 'CAR Second Cycle Date', record.car_second_cycle_date if
                    record else '', 'date', not permissions.defect_description, True) }}

                </div>

            </div>

        </div>



        <div
            class="bg-gradient-to-br from-yellow-50 to-yellow-100 rounded-xl p-6 border-2 border-yellow-200 mt-6 {% if not permissions.process_analysis %}opacity-60{% endif %}">

            <h3 class="text-xl font-bold text-gray-800 mb-4">

                üîç Process Analysis <span class="text-sm font-normal text-gray-600">(Optional)</span>

                {% if not permissions.process_analysis and record.status != 'closed' %}

                <span class="text-sm font-normal text-gray-600">(Manager/Engineer Only)</span>

                {% elif record.status == 'closed' %}

                <span class="text-sm font-normal text-red-600">(Closed - Read Only)</span>

                {% endif %}

            </h3>

            <div class="grid grid-cols-1 gap-4">

                {{ render_textarea('process_description', 'Process Description', record.process_description if record
                else '', not permissions.process_analysis, False) }}

                {{ render_textarea('analysis', 'Analysis', record.analysis if record else '', not
                permissions.process_analysis, False) }}

                {{ render_selector('analysis_by', 'Analysis By', selectors.employees, record.analysis_by if record else
                '', not permissions.process_analysis, False) }}

            </div>

        </div>



        <div
            class="bg-gradient-to-br from-green-50 to-green-100 rounded-xl p-6 border-2 border-green-200 mt-6 {% if not permissions.engineering %}opacity-60{% endif %}">

            <h3 class="text-xl font-bold text-gray-800 mb-4">

                ‚öôÔ∏è Engineering <span class="text-red-600">*</span>

                {% if not permissions.engineering and record.status != 'closed' %}

                <span class="text-sm font-normal text-gray-600">(Engineer Only)</span>

                {% elif record.status == 'closed' %}

                <span class="text-sm font-normal text-red-600">(Closed - Read Only)</span>

                {% endif %}

            </h3>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">

                {{ render_selector('disposition', 'Disposition', selectors.dispositions, record.disposition if record
                else '', not permissions.engineering, True) }}

                {{ render_input('disposition_date', 'Disposition Date', record.disposition_date if record else '',
                'date', not permissions.engineering, True) }}

                {{ render_selector('engineer', 'Engineer', selectors.employees, record.engineer if record else '', not
                permissions.engineering, True) }}

                {{ render_selector('failure_code', 'Failure Code', selectors.failure_codes, record.failure_code if
                record else '', not permissions.engineering, True) }}

                {{ render_input('rework_hours', 'Rework Hours', record.rework_hours if record else '', 'text', not
                permissions.engineering, True) }}

                {{ render_input('responsible_dept', 'Responsible Department', record.responsible_dept if record else '',
                'text', not permissions.engineering, True) }}

                {{ render_input('material_scrap_cost', 'Material Scrap Cost', record.material_scrap_cost if record else
                '', 'text', not permissions.engineering, True) }}

                {{ render_input('others_cost', 'Others Cost', record.others_cost if record else '', 'text', not
                permissions.engineering, True) }}

            </div>

            <div class="grid grid-cols-1 gap-4 mt-4">

                {{ render_textarea('engineering_remarks', 'Engineering Remarks', record.engineering_remarks if record
                else '', not permissions.engineering, True) }}

                {{ render_textarea('repair_process', 'Repair Process', record.repair_process if record else '', not
                permissions.engineering, True) }}

            </div>

        </div>



        <!-- NEW QUALITY SECTION -->

        <div
            class="bg-gradient-to-br from-cyan-50 to-cyan-100 rounded-xl p-6 border-2 border-cyan-200 mt-6 {% if not permissions.engineering %}opacity-60{% endif %}">

            <h3 class="text-xl font-bold text-gray-800 mb-4">

                ‚úÖ Quality <span class="text-sm font-normal text-gray-600">(Optional)</span>

                {% if not permissions.engineering and record.status != 'closed' %}

                <span class="text-sm font-normal text-gray-600">(Quality Department Only)</span>

                {% elif record.status == 'closed' %}

                <span class="text-sm font-normal text-red-600">(Closed - Read Only)</span>

                {% endif %}

            </h3>



            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">

                {{ render_input('disposition_approval_date', 'Disposition Approval Date',
                record.disposition_approval_date if record else '', 'date', not permissions.engineering, False) }}

                {{ render_selector('disposition_approved_by', 'Disposition Approved By', selectors.employees,
                record.disposition_approved_by if record else '', not permissions.engineering, False) }}

                {{ render_input('sdr_number', 'SDR Number', record.sdr_number if record else '', 'text', not
                permissions.engineering, False) }}

            </div>



            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">

                {{ render_input('dmt_approval_date', 'DMT Approval Date', record.dmt_approval_date if record else '',
                'date', not permissions.engineering, False) }}



                {{ render_input('car_closed_date', 'CAR Closed Date', record.car_closed_date if record else '', 'date',
                not permissions.engineering, False) }}

            </div>



            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

                {{ render_checkbox('return_to_disposition', 'Return to Disposition', record.return_to_disposition if
                record else False, not permissions.engineering) }}

                {{ render_checkbox('to_engineer', 'To Engineer', record.to_engineer if record else False, not
                permissions.engineering) }}

            </div>

        </div>



        <div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl p-6 border-2 border-purple-200 mt-6">

            <h3 class="text-xl font-bold text-gray-800 mb-4">üìä Assignment</h3>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

                <div>

                    <label class="block text-sm font-semibold text-gray-700 mb-1">Assign To</label>

                    <select name="assigned_to"
                        class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        {% if record and record.status=='closed' %}disabled{% endif %}>

                        <option value="">-- Select User --</option>

                        {% for u in all_users %}

                        {% if u.role in ['Admin', 'Inspector', 'Supervisor', 'Manager', 'Engineer'] or u.role ==
                        user.role %}

                        <option value="{{ u.id }}" {% if record and record.assigned_to==u.id %}selected{% endif %}>{{
                            u.username }} ({{ u.role }})</option>

                        {% endif %}

                        {% endfor %}

                    </select>

                    <p class="text-xs text-gray-500 mt-1">Workflow: Supervisor ‚Üí Inspector/Superior ‚Üí Engineer ‚Üí Quality
                    </p>

                </div>

            </div>

        </div>



        <div class="flex gap-3 flex-wrap mt-6">

            {% if record and record.status != 'closed' %}

            <button type="button" onclick="submitForm(false)" id="save-session-btn"
                class="bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white font-semibold py-3 px-8 rounded-lg shadow-lg transition-all transform hover:scale-105">

                üíæ Save as Session

            </button>



            <button type="button" onclick="submitForm(true)" id="upload-btn"
                class="bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-semibold py-3 px-8 rounded-lg shadow-lg transition-all transform hover:scale-105">

                ‚úì Upload DMT

            </button>



            {% if permissions.can_close %}

            <button type="button" hx-post="/dmt/close/{{ record.id }}" hx-target="body" hx-swap="beforeend"
                hx-confirm="Are you sure you want to close this DMT? It cannot be edited after closing."
                class="bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white font-semibold py-3 px-8 rounded-lg shadow-lg transition-all transform hover:scale-105">

                üîí Close DMT

            </button>

            {% endif %}

            {% elif not record %}

            <button type="button" onclick="submitForm(false)" id="save-session-btn"
                class="bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white font-semibold py-3 px-8 rounded-lg shadow-lg transition-all transform hover:scale-105">

                üíæ Save as Session

            </button>



            <button type="button" onclick="submitForm(true)" id="upload-btn"
                class="bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-semibold py-3 px-8 rounded-lg shadow-lg transition-all transform hover:scale-105">

                ‚úì Create DMT

            </button>

            {% endif %}



            {% if record and record.status == 'closed' and user.role in ['Admin', 'Inspector'] %}

            <button type="button" hx-post="/dmt/reopen/{{ record.id }}" hx-target="body" hx-swap="beforeend"
                hx-confirm="Are you sure you want to reopen this DMT?"
                class="bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white font-semibold py-3 px-8 rounded-lg shadow-lg transition-all transform hover:scale-105">

                üîì Reopen DMT

            </button>

            {% endif %}



            {% if permissions.can_print %}

            <button type="button" onclick="printDMT()"
                class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg transition">

                üñ®Ô∏è DMT Report

            </button>



            <button type="button" onclick="printCAR()"
                class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg transition">

                üñ®Ô∏è CAR Report

            </button>



            <button type="button" onclick="printMRB()"
                class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg transition">

                üñ®Ô∏è MRB Report

            </button>

            {% endif %}



            <button type="button" hx-get="/dmt/records" hx-target="#main-content"
                class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg transition">

                ‚úï Cancel

            </button>

        </div>

    </form>

</div>



<script>

    function validateRequiredFields() {

        const requiredFields = [

            { name: 'work_center', label: 'Work Center', section: 'general_info' },

            { name: 'part_num', label: 'Part Number', section: 'general_info' },

            { name: 'operation', label: 'Operation', section: 'general_info' },

            { name: 'employee_name', label: 'Employee', section: 'general_info' },

            { name: 'qty', label: 'Quantity', section: 'general_info' },

            { name: 'customer', label: 'Customer', section: 'general_info' },

            { name: 'shop_order', label: 'Shop Order', section: 'general_info' },

            { name: 'serial_number', label: 'Serial Number', section: 'general_info' },

            { name: 'inspection_item', label: 'Inspection Item', section: 'general_info' },

            { name: 'date', label: 'Date', section: 'general_info' },

            { name: 'prepared_by', label: 'Prepared By', section: 'general_info' },

            { name: 'description', label: 'Description', section: 'defect_description' },

            { name: 'car_type', label: 'CAR Type', section: 'defect_description' },

            { name: 'car_cycle', label: 'CAR Cycle', section: 'defect_description' },

            { name: 'car_second_cycle_date', label: 'CAR Second Cycle Date', section: 'defect_description' },

            { name: 'disposition', label: 'Disposition', section: 'engineering' },

            { name: 'disposition_date', label: 'Disposition Date', section: 'engineering' },

            { name: 'engineer', label: 'Engineer', section: 'engineering' },

            { name: 'failure_code', label: 'Failure Code', section: 'engineering' },

            { name: 'rework_hours', label: 'Rework Hours', section: 'engineering' },

            { name: 'responsible_dept', label: 'Responsible Department', section: 'engineering' },

            { name: 'material_scrap_cost', label: 'Material Scrap Cost', section: 'engineering' },

            { name: 'others_cost', label: 'Others Cost', section: 'engineering' },

            { name: 'engineering_remarks', label: 'Engineering Remarks', section: 'engineering' },

            { name: 'repair_process', label: 'Repair Process', section: 'engineering' }

        ];



        const missingFields = [];

        const form = document.getElementById('dmt-form');



        for (const field of requiredFields) {

            const input = form.querySelector(`[name="${field.name}"]`);



            // Only validate if field exists, is not disabled, and is empty

            if (input && !input.disabled && !input.value.trim()) {

                missingFields.push(field.label);

            }

        }



        return missingFields;

    }



    function showError(message) {

        const errorDiv = document.getElementById('form-error-message');

        const errorText = document.getElementById('error-text');

        errorText.textContent = message;

        errorDiv.classList.remove('hidden');



        // Scroll to top to show error

        window.scrollTo({ top: 0, behavior: 'smooth' });



        // Hide error after 5 seconds

        setTimeout(() => {

            errorDiv.classList.add('hidden');

        }, 5000);

    }



    function submitForm(isUpload) {

        const form = document.getElementById('dmt-form');

        const saveAsSessionInput = document.getElementById('save_as_session');

        const errorDiv = document.getElementById('form-error-message');



        // Hide any previous errors

        errorDiv.classList.add('hidden');



        // Only validate required fields when uploading (not for sessions)

        if (isUpload) {

            const missingFields = validateRequiredFields();

            if (missingFields.length > 0) {

                showError(`Please fill in all required fields: ${missingFields.join(', ')}`);

                return;

            }

        }



        saveAsSessionInput.value = isUpload ? 'false' : 'true';



        const formData = new FormData(form);



        {% if record %}

        const url = '/dmt/update/{{ record.id }}';

        {% else %}

        const url = '/dmt/create';

        {% endif %}



        // Disable buttons to prevent double submission

        const buttons = document.querySelectorAll('#save-session-btn, #upload-btn');

        buttons.forEach(btn => {

            btn.disabled = true;

            btn.classList.add('opacity-50', 'cursor-not-allowed');

            btn.innerHTML = btn.innerHTML.replace('üíæ', '‚è≥').replace('‚úì', '‚è≥');

        });



        console.log('[v0] Submitting form to:', url, 'isUpload:', isUpload);



        fetch(url, {

            method: 'POST',

            body: formData

        })

            .then(response => {

                console.log('[v0] Response status:', response.status);



                // Check if response is successful (2xx or 3xx status codes)

                if (response.ok || response.status === 303 || response.status === 302) {

                    console.log('[v0] Save successful, redirecting to records list');

                    // Success - redirect to records list using HTMX

                    htmx.ajax('GET', '/dmt/records', { target: '#main-content', swap: 'innerHTML' });

                    return null; // Return null to indicate success

                } else {

                    // Error response - get the error message

                    return response.text().then(text => {

                        throw new Error(text || 'Failed to save DMT');

                    });

                }

            })

            .catch(error => {

                // Only show error if there was an actual error (not null from success case)

                if (error) {

                    console.error('[v0] Error submitting form:', error);

                    showError(error.message || 'An error occurred while saving the DMT');



                    // Re-enable buttons

                    buttons.forEach(btn => {

                        btn.disabled = false;

                        btn.classList.remove('opacity-50', 'cursor-not-allowed');

                        btn.innerHTML = btn.innerHTML.replace('‚è≥', btn.id === 'save-session-btn' ? 'üíæ' : '‚úì');

                    });

                }

            });

    }



    document.addEventListener('htmx:afterSwap', function (event) {

        if (event.detail.target.id === 'employee_name_results') {

            const results = event.detail.target;

            if (results.innerHTML.trim() !== '') {

                results.classList.remove('hidden');



                // Add click handlers to all employee options

                const options = results.querySelectorAll('.employee-option');

                options.forEach(option => {

                    option.addEventListener('click', function (e) {

                        e.preventDefault();

                        e.stopPropagation();

                        const id = this.getAttribute('data-id');

                        const name = this.getAttribute('data-name');

                        selectEmployee(id, name);

                    });

                });

            }

        }

    });



    document.addEventListener('click', function (event) {

        const searchInput = document.getElementById('employee_name_search');

        const resultsDiv = document.getElementById('employee_name_results');



        if (searchInput && resultsDiv && !searchInput.contains(event.target) && !resultsDiv.contains(event.target)) {

            resultsDiv.classList.add('hidden');

        }

    });



    const employeeSearchInput = document.getElementById('employee_name_search');

    if (employeeSearchInput) {

        employeeSearchInput.addEventListener('focus', function () {

            const resultsDiv = document.getElementById('employee_name_results');

            if (resultsDiv && resultsDiv.innerHTML.trim() !== '') {

                resultsDiv.classList.remove('hidden');

            }

        });

    }



    function selectEmployee(id, name) {

        console.log('[v0] Selecting employee:', id, name);

        document.getElementById('employee_name_search').value = name;

        document.getElementById('employee_name_hidden').value = id;

        document.getElementById('employee_name_results').classList.add('hidden');

    }



    function printDMT() {

        document.body.classList.add('print-dmt');

        document.body.classList.remove('print-car');

        document.body.classList.remove('print-mrb');

        window.print();

        document.body.classList.remove('print-dmt');

    }



    function printCAR() {

        // Inject CAR-specific content dynamically
        const carTitle = document.createElement('h2');
        carTitle.id = 'car-title';
        const form = document.getElementById('dmt-form');

        const carHeader = document.createElement('div');

        carHeader.id = 'car-header-info';

        carHeader.innerHTML = `

        <strong>CAR No:</strong> ${form.querySelector('[name="report_number"]')?.value || 'N/A'}  |  

        <strong>Part No:</strong> ${form.querySelector('[name="part_num"]')?.selectedOptions[0]?.text || 'N/A'}  |  

        <strong>Date:</strong> ${form.querySelector('[name="date"]')?.value || 'N/A'}<br>

        <strong>Issued By:</strong> ${form.querySelector('[name="prepared_by"]')?.selectedOptions[0]?.text || 'N/A'}  |  

        <strong>Assigned To:</strong> ${form.querySelector('[name="assigned_to"]')?.selectedOptions[0]?.text || 'N/A'}  |  

        <strong>CAR Type:</strong> ${form.querySelector('[name="car_type"]')?.selectedOptions[0]?.text || 'DMT'}

    `;



        const carFooter = document.createElement('div');

        carFooter.id = 'car-footer-info';

        carFooter.innerHTML = `

<strong>ROOT CAUSE / Causa Ra√≠z:</strong>

${form.querySelector('[name="analysis"]')?.value || '_'.repeat(100)}
<strong>IMMEDIATE CORRECTIVE ACTION / Acci√≥n Correctiva Inmediata:</strong>

${form.querySelector('[name="repair_process"]')?.value || '_'.repeat(100)}
<strong>PREVENTIVE ACTION / Acci√≥n Preventiva:</strong>

${form.querySelector('[name="engineering_remarks"]')?.value || '_'.repeat(100)}

<strong>FACILITATOR:             </strong><strong>Date:                               </strong><strong>Signature:</strong> 
________________             ___________________            _______________
________________             ___________________            _______________
________________             ___________________            _______________
________________             ___________________            _______________
________________             ___________________            _______________
________________             ___________________            _______________        
<strong>REVIEWED BY (Issuer/ME):</strong> ${form.querySelector('[name="engineer"]')?.selectedOptions[0]?.text || '______________________'}  <strong>Date:</strong> __________

<strong>Review Status:</strong>  ‚òê Satisfactorio  ‚òê No satisfactorio

<strong>CLOSE CAR DATE:</strong> __________  <strong>Accepted By (QM/QE):</strong> ______________________  <strong>Date:</strong> __________

    `;



        
        form.insertBefore(carTitle, form.firstChild);
        form.appendChild(carHeader);

        form.appendChild(carFooter);



        document.body.classList.add('print-car');

        document.body.classList.remove('print-dmt');

        document.body.classList.remove('print-mrb');

        window.print();

        document.body.classList.remove('print-car');



        // Clean up injected elements

        carTitle.remove();
        carHeader.remove();
        carFooter.remove();

    }



    function printMRB() {
        const mrbTitle = document.createElement('h2');
        mrbTitle.id = 'mrb-title';
        // Calculate total cost

        const materialCost = parseFloat(document.querySelector('[name="material_scrap_cost"]')?.value || 0);

        const otherCost = parseFloat(document.querySelector('[name="others_cost"]')?.value || 0);

        const totalCost = materialCost + otherCost;


        
        // Inject MRB-specific header

        const form = document.getElementById('dmt-form');

        const mrbHeader = document.createElement('div');

        mrbHeader.id = 'mrb-cost-section';

        mrbHeader.innerHTML = `

<div style="border: 2px solid #000; padding: 10px; margin: 10px 0;">

    <strong>COST ACCOUNTING:</strong><br>

    Material: ${materialCost.toFixed(2)}    Other: ${otherCost.toFixed(2)}    <strong>Total: ${totalCost.toFixed(2)}</strong>

</div>



<div style="border: 2px solid #000; padding: 10px; margin: 10px 0;">

    <strong>VERDICT:</strong>    ‚òê Use    ‚òê Rework    ‚òê Scrap<br><br>

    <strong>REWORK/SCRAP/SDR OPTIONS:</strong><br>

    ‚òê MFG    ‚òê QE    ‚òê EM    ‚òê QM

</div>

    `;


    form.appendChild(mrbTitle);
        form.appendChild(mrbHeader);



        document.body.classList.add('print-mrb');

        document.body.classList.remove('print-dmt');

        document.body.classList.remove('print-car');

        window.print();

        document.body.classList.remove('print-mrb');



        // Clean up

        mrbHeader.remove();

    }

</script>



<style>
    /* DMT Print Styles - F19.00-09 */

    @media print {

        body.print-dmt * {
            visibility: hidden;
        }

        body.print-dmt #dmt-form,
        body.print-dmt #dmt-form * {
            visibility: visible;
        }

        body.print-dmt button,
        body.print-dmt #form-error-message,
        body.print-dmt .flex.gap-3.flex-wrap,

        body.print-dmt .px-4.py-2.rounded-lg.font-semibold {
            display: none !important;
        }



        @page {
            size: letter portrait;
            margin: 0.5in;
        }

        html,
        body {
            margin: 0 !important;
            padding: 0 !important;
        }



        body.print-dmt .bg-white.rounded-xl.shadow-xl {

            position: absolute;
            top: 0;
            left: 0;
            width: 100%;

            box-shadow: none !important;
            padding: 20px !important;
            background: white !important;

        }



        /* Header with Form Number */

        body.print-dmt h2::before {

            content: "DEFECTIVE MATERIAL TAG (DMT)\AForm " !important;

            white-space: pre-wrap !important;

            display: block !important;

            text-align: center !important;

            font-size: 16px !important;

            font-weight: bold !important;

            border-bottom: 3px solid #000 !important;

            padding-bottom: 8px !important;

            margin-bottom: 15px !important;

        }



        body.print-dmt h2 {
            display: none !important;
        }

        body.print-dmt h3 {
            display: none !important;
        }

        body.print-dmt .bg-gradient-to-br {
            padding: 0 !important;
            margin: 0 !important;
            border: none !important;
            background: white !important;
        }



        /* General Info - Compact Grid */

        body.print-dmt .bg-gradient-to-br.from-blue-50 {
            margin-bottom: 8px !important;
        }

        body.print-dmt .bg-gradient-to-br.from-blue-50 .grid {

            display: grid !important;

            grid-template-columns: repeat(4, 1fr) !important;

            gap: 0 !important;

            border: 2px solid #000;

        }

        body.print-dmt .bg-gradient-to-br.from-blue-50 .grid>div {

            border: 1px solid #333;

            padding: 3px 5px !important;

        }



        /* Defect Description - Full Width */

        body.print-dmt .bg-gradient-to-br.from-red-50 {
            margin-bottom: 8px !important;
        }

        body.print-dmt .bg-gradient-to-br.from-red-50 .grid {

            display: block !important;

            border: 2px solid #000;

            padding: 5px !important;

        }

        body.print-dmt .bg-gradient-to-br.from-red-50 textarea[name="description"] {

            min-height: 80px !important;

            width: 100% !important;

        }

        body.print-dmt .bg-gradient-to-br.from-red-50 .space-y-4 {

            display: grid !important;

            grid-template-columns: repeat(3, 1fr) !important;

            gap: 0 !important;

            border-top: 1px solid #000;

            margin-top: 5px !important;

        }

        body.print-dmt .bg-gradient-to-br.from-red-50 .space-y-4>div {

            border: 1px solid #333;

            padding: 3px 5px !important;

        }



        /* Engineering Section */

        body.print-dmt .bg-gradient-to-br.from-green-50 {
            margin-bottom: 8px !important;
        }

        body.print-dmt .bg-gradient-to-br.from-green-50>.grid:first-of-type {

            display: grid !important;

            grid-template-columns: repeat(4, 1fr) !important;

            gap: 0 !important;

            border: 2px solid #000;

        }

        body.print-dmt .bg-gradient-to-br.from-green-50>.grid:first-of-type>div {

            border: 1px solid #333;

            padding: 3px 5px !important;

        }

        body.print-dmt .bg-gradient-to-br.from-green-50>.grid:last-of-type {

            display: grid !important;

            grid-template-columns: 1fr 1fr !important;

            gap: 0 !important;

            border: 2px solid #000;

            border-top: none;

        }

        body.print-dmt .bg-gradient-to-br.from-green-50>.grid:last-of-type>div {

            border: 1px solid #333;

            padding: 5px !important;

            min-height: 60px;

        }



        /* Hide Process Analysis and Quality sections */

        body.print-dmt .bg-gradient-to-br.from-yellow-50,

        body.print-dmt .bg-gradient-to-br.from-cyan-50,

        body.print-dmt .bg-gradient-to-br.from-purple-50 {
            display: none !important;
        }



        /* Signature Block */

        body.print-dmt #dmt-form::after {

            content: "Engineer Sign: ______________________ Date: ________        Quality Sign: ______________________ Date: ________" !important;

            display: block !important;

            margin-top: 20px !important;

            border: 2px solid #000 !important;

            padding: 15px !important;

            font-size: 10px !important;

            font-weight: bold !important;

            text-align: center !important;

            visibility: visible !important;

        }



        body.print-dmt label {

            font-size: 8px !important;

            font-weight: bold !important;

            text-transform: uppercase !important;

            margin-bottom: 2px !important;

            display: block !important;

        }

        body.print-dmt input,
        body.print-dmt select {

            font-size: 10px !important;

            padding: 2px !important;

            border: none !important;

            border-bottom: 1px solid #333 !important;

            width: 100% !important;

            background: transparent !important;

        }

        body.print-dmt textarea {

            font-size: 10px !important;

            padding: 3px !important;

            border: none !important;

            width: 100% !important;

            background: transparent !important;

        }

        body.print-dmt p,
        body.print-dmt span.text-sm,
        body.print-dmt span.text-xs {
            display: none !important;
        }

    }



    /* CAR Print Styles - F19.00-09 */


    @media print {
        /* ... (keep your other print styles above this) ... */

        body.print-car * {
            visibility: hidden;
        }

        body.print-car h2,
        body.print-car #car-title,
        body.print-car .flex.justify-between.items-center.mb-6
        {
            visibility: visible;
        
        }
        body.print-car #dmt-form,
        body.print-car #dmt-form * {
            visibility: visible;
        }

        body.print-car button,
        body.print-car #form-error-message,
        body.print-car .flex.gap-3.flex-wrap,
        body.print-car .px-4.py-2.rounded-lg.font-semibold {
            display: none !important;
        }

        @page {
            size: letter portrait;
            margin: 0.5in;
        }

        html,
        body {
            margin: 0 !important;
            padding: 0 !important;
        }

        body.print-car .bg-white.rounded-xl.shadow-xl {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 80%;
            box-shadow: none !important;
            padding: 20px !important;
            background: white !important;
        }

        /* CAR Header */
        body.print-car h2::before {
            content: "CORRECTIVE ACTION REQUEST(CAR) Form" !important;
            white-space: pre-wrap !important;
            display: block !important;
            text-align: center !important;
            font-size: 16px !important;
            font-weight: bold !important;
            border-bottom: 3px solid #000 !important;
            padding-bottom: 8px !important;
            margin-bottom: 12px !important;
        }

        body.print-car h3,
        body.print-car .flex.justify-between.items-center.mb-6 {
            display: none !important;
        }

        /* Show injected header info */
        body.print-car #car-header-info {
            display: block !important;
            visibility: visible !important;
            font-size: 10px !important;
            line-height: 1.8 !important;
            margin-bottom: 15px !important;
            border: 2px solid #000 !important;
            padding: 8px !important;
        }

        /* Hide all sections except Defect Description */
        body.print-car .bg-gradient-to-br.from-blue-50,
        body.print-car .bg-gradient-to-br.from-yellow-50,
        body.print-car .bg-gradient-to-br.from-green-50,
        body.print-car .bg-gradient-to-br.from-cyan-50,
        body.print-car .bg-gradient-to-br.from-purple-50 {
            display: none !important;
        }

        /* Show Defect Description only */
        body.print-car .bg-gradient-to-br.from-red-50 {
            display: block !important;
            visibility: visible !important;
            border: 2px solid #000 !important;
            padding: 0 !important;
            margin-bottom: 12px !important;
            background: white !important;
        }

        body.print-car .bg-gradient-to-br.from-red-50 h3 {
            display: block !important;
            font-size: 11px !important;
            font-weight: bold !important;
            background: #333 !important;
            color: white !important;
            padding: 5px 8px !important;
            margin: 0 !important;
        }

        /* === CORRECTED PART === */
        /* Defect Description content styles for CAR */
        body.print-car .bg-gradient-to-br.from-red-50 .grid {
            display: block !important;
            padding: 5px !important;
        }

        /* Make the textarea smaller */
        body.print-car .bg-gradient-to-br.from-red-50 textarea[name="description"] {
            min-height: 40px !important;
            /* Reduced from 80px */
            width: 100% !important;
            /* Set to full width */
            border: none !important;
        }

        /* Styles for the fields below the description */
        body.print-car .bg-gradient-to-br.from-red-50 .space-y-4 {
            display: grid !important;
            grid-template-columns: repeat(3, 1fr) !important;
            gap: 0 !important;
            border-top: 1px solid #000;
            margin-top: 5px !important;
        }

        body.print-car .bg-gradient-to-br.from-red-50 .space-y-4>div {
            border: 1px solid #333;
            padding: 3px 5px !important;
        }

        /* === END OF CORRECTION === */

        /* Show injected footer content */
        body.print-car #car-footer-info {
            display: block !important;
            visibility: visible !important;
            white-space: pre-wrap !important;
            font-size: 10px !important;
            line-height: 1.8 !important;
            border: 2px solid #000 !important;
            padding: 10px !important;
            margin-top: 10px !important;
        }

        body.print-car label {
            display: none !important;
        }

        body.print-car p,
        body.print-car span.text-sm,
        body.print-car span.text-xs {
            display: none !important;
        }
    }

    /* ... (keep your MRB Print Styles below this) ... */



    /* MRB Print Styles - F19.00-09 */

    @media print {
        
        body.print-mrb * {
            visibility: hidden;
        }
        body.print-car h2,
        body.print-car #mrb-title,
        body.print-car .flex.justify-between.items-center.mb-6
        {
            visibility: visible;
        
        }

        body.print-mrb #dmt-form,
        body.print-mrb #dmt-form * {
            visibility: visible;
        }

        body.print-mrb button,
        body.print-mrb #form-error-message,
        body.print-mrb .flex.gap-3.flex-wrap,

        body.print-mrb .px-4.py-2.rounded-lg.font-semibold {
            display: none !important;
        }



        @page {
            size: letter portrait;
            margin: 0.5in;
        }

        html,
        body {
            margin: 0 !important;
            padding: 0 !important;
        }



        body.print-mrb .bg-white.rounded-xl.shadow-xl {

            position: absolute;
            top: 0;
            left: 0;
            width: 100%;

            box-shadow: none !important;
            padding: 20px !important;
            background: white !important;

        }



        /* MRB Header */

        body.print-mrb h2::before {

            content: "MATERIAL REVIEW BOARD (MRB) REPORT\AForm No: F19.00-09" !important;

            white-space: pre-wrap !important;

            display: block !important;

            text-align: center !important;

            font-size: 16px !important;

            font-weight: bold !important;

            border-bottom: 3px solid #000 !important;

            padding-bottom: 8px !important;

            margin-bottom: 15px !important;

        }



        body.print-mrb h2,
        body.print-mrb h3 {
            display: none !important;
        }



        /* Hide Process Analysis and Assignment sections */

        body.print-mrb .bg-gradient-to-br.from-yellow-50,

        body.print-mrb .bg-gradient-to-br.from-cyan-50,

        body.print-mrb .bg-gradient-to-br.from-purple-50 {
            display: none !important;
        }



        /* General Info Section */

        body.print-mrb .bg-gradient-to-br.from-blue-50 {

            display: block !important;

            visibility: visible !important;

            border: 2px solid #000 !important;

            padding: 8px !important;

            margin-bottom: 10px !important;

            background: white !important;

        }



        body.print-mrb .bg-gradient-to-br.from-blue-50 h3 {

            font-size: 11px !important;

            font-weight: bold !important;

            background: #333 !important;

            color: white !important;

            padding: 4px 8px !important;

            margin: 0 0 8px 0 !important;

            display: block !important;

        }



        body.print-mrb .bg-gradient-to-br.from-blue-50 h3::before {

            content: "GENERAL INFORMATION" !important;

        }



        body.print-mrb .bg-gradient-to-br.from-blue-50 .grid {

            display: grid !important;

            grid-template-columns: repeat(3, 1fr) !important;

            gap: 5px !important;

        }



        /* Defect Description */

        body.print-mrb .bg-gradient-to-br.from-red-50 {

            display: block !important;

            visibility: visible !important;

            border: 2px solid #000 !important;

            padding: 8px !important;

            margin-bottom: 10px !important;

            background: white !important;

        }



        body.print-mrb .bg-gradient-to-br.from-red-50 h3 {

            font-size: 11px !important;

            font-weight: bold !important;

            background: #333 !important;

            color: white !important;

            padding: 4px 8px !important;

            margin: 0 0 8px 0 !important;

            display: block !important;

        }



        body.print-mrb .bg-gradient-to-br.from-red-50 h3::before {

            content: "DEFECT DESCRIPTION" !important;

        }



        /* Engineering Section */

        body.print-mrb .bg-gradient-to-br.from-green-50 {

            display: block !important;

            visibility: visible !important;

            border: 2px solid #000 !important;

            padding: 8px !important;

            margin-bottom: 10px !important;

            background: white !important;

        }



        body.print-mrb .bg-gradient-to-br.from-green-50 h3 {

            font-size: 11px !important;

            font-weight: bold !important;

            background: #333 !important;

            color: white !important;

            padding: 4px 8px !important;

            margin: 0 0 8px 0 !important;

            display: block !important;

        }



        body.print-mrb .bg-gradient-to-br.from-green-50 h3::before {

            content: "ENGINEERING ASSESSMENT & DISPOSITION" !important;

        }



        /* Cost Section - dynamically injected */

        body.print-mrb #mrb-cost-section {

            display: block !important;

            visibility: visible !important;

        }



        /* Footer Signatures */

        body.print-mrb #dmt-form::after {

            content: "Mechanical Engineer (ME): _________________________    Date: __________\A\AQuality Engineer (QE): _________________________    Date: __________\A\AQuality Manager (QM): _________________________    Date: __________\A\ASigning Authorization: _________________________    Date: __________" !important;

            display: block !important;

            white-space: pre-wrap !important;

            border-top: 2px solid #000 !important;

            padding-top: 10px !important;

            margin-top: 15px !important;

            font-size: 10px !important;

            font-weight: bold !important;

            line-height: 1.8 !important;

            visibility: visible !important;

        }



        body.print-mrb label {

            font-size: 9px !important;

            font-weight: bold !important;

            display: block !important;

            margin-bottom: 2px !important;

            text-transform: uppercase !important;

        }



        body.print-mrb input,
        body.print-mrb select {

            font-size: 10px !important;

            border: none !important;

            border-bottom: 1px solid #333 !important;

            width: 100% !important;

            padding: 2px !important;

            background: transparent !important;

        }



        body.print-mrb textarea {

            font-size: 10px !important;

            border: 1px solid #333 !important;

            padding: 5px !important;

            min-height: 60px !important;

            background: transparent !important;

        }



        body.print-mrb input[type="checkbox"] {

            width: 15px !important;

            height: 15px !important;

            margin-right: 5px !important;

        }



        body.print-mrb p,
        body.print-mrb span.text-sm,
        body.print-mrb span.text-xs {
            display: none !important;
        }

    }
</style>